# Avant propos

Je me suis inspiré de [Web Application Exploits and Defenses](https://google-gruyere.appspot.com/part1) et suivants, pour vous faire
ce qui suit en français.

## Installation

Pour installer Gruyère et pouvoir l'utiliser avec un python3 récent, dans Documents/GIT, exécutez : 

```bash
git clone https://github.com/ab-smith/gruyere.git

sudo apt install python3-future
```

Puis, dans le fichier gtl.py, ajouter "abc." devant les  "Mapping" et "Sequence" de l'objet collections.

Pour la raison suivante : [Abstract Base Class](https://docs.python.org/3/library/collections.abc.html) 


Un backup de la version utilisable. depuis le répertoire Documents/GIT/, pour pouvoir y revenir en cas de soucis :

```bash
tar zcvf gruyere.tgz gruyere
```

## Démarrage 

Gruyère se lance depuis le répertoire de l'application, avec la commande :

```bash
python gruyere.py
```

On s'y connecte à l'adresse http://localhost:8008 avec le browser disponbile dans la VM M2I : firefox 


**AVERTISSEMENT** : Gruyère étant très vulnérable, il inclut une certaine protection contre l'exploitation par un attaquant externe lorsqu'il est exécuté localement. Vous verrez des parties du code marquées NE PAS CHANGER. Gruyère n'accepte que les demandes de localhost et utilise un identifiant unique aléatoire dans l'URL. Il est cependant difficile de se protéger totalement contre une attaque extérieure. Et si vous apportez des modifications à Gruyère, vous pourriez le rendre plus vulnérable à une véritable attaque. Par conséquent, vous devez fermer les autres pages Web lorsque vous exécutez Gruyère localement et vous devez vous assurer qu'aucun autre utilisateur n'est connecté à la machine que vous utilisez.


### À propos du code

Le gruyère est petit et compact. Voici un bref aperçu du code de l’application :

-   `gruyere.py` est le serveur web principal du Gruyère
-   `data.py` stocke les données par défaut dans la base de données. Il existe un compte administrateur et deux utilisateurs par défaut.
-   `gtl.py` est le langage modèle du Gruyère
-   `sanitize.py` est le module Gruyère utilisé pour nettoyer le HTML afin de protéger l'application des failles de sécurité.
-   `resources/...` contient tous les fichiers de modèles, images, CSS, etc.
  

### Fonctionnalités et technologies

Le Gruyère comprend un certain nombre de fonctionnalités et de technologies spéciales qui ajoutent une surface d'attaque. Nous les mettrons en évidence ici afin que vous en soyez conscient lorsque vous tenterez de l'attaquer. Chacun d’eux introduit de nouvelles vulnérabilités.

-   **HTML dans les extraits de code** : les utilisateurs peuvent inclure un sous-ensemble limité de HTML dans leurs extraits de code.
-   **Téléchargement de fichiers** : les utilisateurs peuvent télécharger des fichiers sur le serveur, par exemple pour inclure des images dans leurs extraits.
-   **Administration Web** : les administrateurs système peuvent gérer le système à l'aide d'une interface Web.
-   **Nouveaux comptes** : les utilisateurs peuvent créer leurs propres comptes.
-   **Langage de modèle** : Gruyere Template Language (GTL) est un nouveau langage qui facilite la rédaction de pages Web car les modèles se connectent directement à la base de données. La documentation pour GTL peut être trouvée dans `gruyere/gtl.py`.
-   **AJAX** : Gruyère utilise AJAX pour implémenter l'actualisation de la page d'accueil et des extraits de code. Vous devez ignorer les parties AJAX du Gruyère, à l'exception des défis qui vous demandent spécifiquement de vous concentrer sur AJAX.  

Dans une application réelle, l'actualisation se produirait probablement automatiquement, mais chez Gruyère, nous l'avons rendu manuel afin que vous puissiez avoir un contrôle total pendant que vous travaillez avec. 

Lorsque vous cliquez sur le lien d'actualisation, Gruyère récupère avec `feed.gtl` les données d'actualisation pour la page actuelle, puis le script côté client utilise l'API DOM (Document Object Model) du navigateur pour insérer les nouveaux extraits de code dans la page. Étant donné qu'AJAX exécute du code côté client, ce script est visible pour les attaquants qui n'ont pas accès à votre code source.

  
## Utiliser gruyère

Pour vous familiariser avec les fonctionnalités du gruyère, effectuez les tâches suivantes :

-   Affichez les extraits d'un autre utilisateur en suivant le lien « Tous les extraits » sur la page principale. Vérifiez également sur quoi leur page d’accueil est définie.
-   Créez un compte que vous pourrez utiliser lors du piratage. **N'utilisez pas le même mot de passe pour votre compte Gruyère que celui que vous utilisez pour n'importe quel service réel.**
-   Remplissez le profil de votre compte, y compris un extrait privé et une icône qui sera affichée à côté de votre nom.
-   Créez un extrait (via "New Snippet") contenant votre blague préférée.
-   Téléchargez un fichier (via "Télécharger") sur votre compte.

Cela couvre les fonctionnalités de base fournies par le Gruyère. Maintenant, brisons-les !